name: ü§ñ MatVerse Auto-Build & Evidence Registry

on:
  push:
    branches: [main]
    paths:
      - 'papers/**'
      - 'evidence/**'
      - '.github/workflows/**'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly validation

jobs:
  build-and-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîß Set up environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y tar gzip sha256sum python3
          python3 --version

      - name: üì¶ Generate tarballs for all papers
        run: |
          mkdir -p dist
          
          PAPERS=(
            "paper-0-foundations"
            "paper-1-coherent-action-spaces"
            "paper-2-acoa"
            "paper-3-omega-gate"
          )
          
          for PAPER_DIR in "${PAPERS[@]}"; do
            PAPER_PATH="papers/$PAPER_DIR"
            PACKAGE_NAME="$PAPER_DIR-v1"
            TARBALL="dist/$PACKAGE_NAME.tar.gz"
            
            if [ -d "$PAPER_PATH" ]; then
              echo "üì¶ Packaging: $PAPER_DIR"
              cd "$PAPER_PATH"
              tar czf "../../$TARBALL" \
                --exclude='.git' \
                --exclude='.DS_Store' \
                --exclude='*.log' \
                --exclude='*.aux' \
                --exclude='*.fls' \
                --exclude='*.fdb_latexmk' \
                --exclude='build' \
                .
              cd ../../
              SHA256=$(sha256sum "$TARBALL" | awk '{print $1}')
              echo "   ‚úÖ SHA256: $SHA256"
            fi
          done

      - name: üîê Validate & update evidence registry
        run: |
          python3 << 'EOF'
          import json
          import hashlib
          import os
          from datetime import datetime
          from pathlib import Path
          
          dist_dir = Path("dist")
          evidence_file = Path("evidence/index.json")
          
          # Load existing registry
          with open(evidence_file, 'r') as f:
            registry = json.load(f)
          
          # Update each artifact
          artifacts = registry.get("artifacts", [])
          for artifact in artifacts:
            tarball_name = artifact["id"] + ".tar.gz"
            tarball_path = dist_dir / tarball_name
            
            if tarball_path.exists():
              # Calculate SHA256
              sha256_hash = hashlib.sha256()
              with open(tarball_path, 'rb') as f:
                for chunk in iter(lambda: f.read(4096), b''):
                  sha256_hash.update(chunk)
              
              artifact["sha256"] = sha256_hash.hexdigest()
              artifact["size_bytes"] = tarball_path.stat().st_size
              artifact["status"] = "ready-for-submission"
          
          # Update timestamp
          registry["updated_at"] = datetime.utcnow().isoformat() + "Z"
          
          # Write back
          with open(evidence_file, 'w') as f:
            json.dump(registry, f, indent=2, ensure_ascii=False)
          
          print("‚úÖ Evidence registry updated")
          print(json.dumps(registry, indent=2))
          EOF

      - name: üìä Generate build report
        run: |
          echo "## Build Report - $(date)" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "**Tarballs Generated:**" >> /tmp/report.md
          ls -lh dist/*.tar.gz | awk '{print "- " $9 " (" $5 ")"}' >> /tmp/report.md || echo "- No tarballs" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "**SHA256 Checksums:**" >> /tmp/report.md
          echo "\`\`\`" >> /tmp/report.md
          cat dist/SHA256SUMS.txt 2>/dev/null || sha256sum dist/*.tar.gz >> /tmp/report.md
          echo "\`\`\`" >> /tmp/report.md
          cat /tmp/report.md

      - name: üíæ Commit evidence registry updates
        run: |
          git config user.email "ci-bot@matverse-acoa.local"
          git config user.name "MatVerse CI Bot"
          git add evidence/index.json
          git commit -m "üîê chore: auto-update evidence registry with SHA256 hashes [CI]" \
            --allow-empty || echo "Nothing to commit"
          git push origin main || echo "Already up to date"

      - name: üè∑Ô∏è Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: matverse-papers-${{ github.run_id }}
          name: "MatVerse Papers Bundle - Build ${{ github.run_id }}"
          files: dist/*.tar.gz
          body: |
            # MatVerse arXiv Submission Bundle
            
            **Build:** ${{ github.run_id }}  
            **Timestamp:** ${{ github.event.head_commit.timestamp }}  
            **Commit:** ${{ github.sha }}
            
            All 4 papers packaged and ready for arXiv submission.
            
            **Papers:**
            - Paper 0: Foundations of Coherent Action Spaces
            - Paper 1: Coherent Action Spaces (Tensorial Invariant Model)
            - Paper 2: ACOA (Autopoiesis Without Control)
            - Paper 3: Œ©-GATE Kernel (Reference Implementation)
            
            **Evidence:** See `evidence/index.json` for SHA256 hashes
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìß Notify on success
        if: success()
        run: |
          echo "‚úÖ MatVerse auto-build complete"
          echo "üì¶ Tarballs ready: $(ls -1 dist/*.tar.gz | wc -l) files"
          echo "üîê Evidence registry updated"
          echo "üè∑Ô∏è GitHub Release created"

  validate-integrity:
    needs: build-and-audit
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚úÖ Verify tarball integrity
        run: |
          cd dist
          if [ -f SHA256SUMS.txt ]; then
            sha256sum -c SHA256SUMS.txt
          else
            echo "Generating SHA256SUMS..."
            sha256sum *.tar.gz > SHA256SUMS.txt
            cat SHA256SUMS.txt
          fi

      - name: üìã List all artifacts
        run: |
          echo "## All Build Artifacts"
          find dist -type f -exec ls -lh {} \; | awk '{print $5, $9}'
